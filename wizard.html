<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG Pomodoro - Premium UI</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #09090b;
            --glass-bg: rgba(20, 20, 35, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            
            --primary-gradient: linear-gradient(135deg, #8b5cf6 0%, #d946ef 100%);
            --gold-gradient: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            --blue-gradient: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #f43f5e 100%);
            
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* --- 3D Canvas Layer --- */
        #game-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            background: radial-gradient(circle at center, #1e1b4b 0%, #000000 100%);
            cursor: grab;
        }
        #game-canvas.grabbing { cursor: grabbing; }

        /* --- UI HUD Layer --- */
        .hud {
            position: absolute; z-index: 10; padding: 24px;
            pointer-events: none; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .hud__interactive { pointer-events: auto; }

        /* --- TOP STATS BAR --- */
        .stats-container {
            display: flex; flex-direction: column; gap: 10px; align-self: flex-start;
            min-width: 320px; transition: all 0.3s ease;
        }

        .stats-bar {
            display: flex; gap: 16px; 
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 12px 20px;
            border-radius: var(--radius-lg);
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            align-items: center;
        }

        .avatar-circle {
            width: 48px; height: 48px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; color: white;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
            border: 2px solid rgba(255,255,255,0.2);
            cursor: pointer; flex-shrink: 0;
            transition: transform 0.1s;
        }
        .avatar-circle:active { transform: scale(0.9); }

        .stat-group { display: flex; flex-direction: column; flex: 1; min-width: 0; }
        .char-name { font-weight: 800; font-size: 0.9rem; letter-spacing: 0.5px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .resource-row { display: flex; align-items: center; gap: 12px; margin-top: 2px; }
        .bar-wrapper { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .bar-label { font-size: 0.65rem; color: var(--text-muted); font-weight: 600; display: flex; justify-content: space-between; }
        
        .progress-track { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; border-radius: 10px; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .xp-fill { background: var(--gold-gradient); box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); }
        .stamina-fill { background: var(--primary-gradient); box-shadow: 0 0 10px rgba(139, 92, 246, 0.5); }
        .stamina-fill.low { background: var(--danger-gradient); }

        /* --- MOBILE TOGGLE BUTTON --- */
        .mobile-quest-toggle {
            display: none;
            background: rgba(20, 20, 35, 0.9);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px 20px;
            border-radius: var(--radius-lg);
            color: white; font-weight: 600; font-size: 0.9rem;
            align-items: center; justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        .mobile-quest-toggle i { color: #d946ef; margin-right: 8px; }

        /* --- QUEST BOARD --- */
        .quest-log {
            position: absolute; top: 24px; right: 24px; width: 360px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(12px);
            max-height: 70vh; display: flex; flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s, max-height 0.3s;
        }

        .quest-log.minimized {
            max-height: 70px; /* Only header height */
            background: rgba(20, 20, 35, 0.85);
        }

        .quest-header {
            padding: 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer;
        }
        .quest-header h3 { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 8px; margin: 0; }
        
        .header-actions { display: flex; gap: 8px; }

        .icon-btn {
            width: 32px; height: 32px; border-radius: 8px;
            background: rgba(255,255,255,0.1); border: none; color: white;
            cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background: white; color: black; transform: translateY(-2px); }
        .icon-btn.close-mobile { display: none; }

        .quest-content { overflow-y: auto; flex: 1; padding: 16px; display: flex; flex-direction: column; gap: 16px; opacity: 1; transition: opacity 0.2s; }
        .quest-log.minimized .quest-content { opacity: 0; pointer-events: none; }
        
        .section-label { 
            font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; 
            display: flex; align-items: center; gap: 8px;
        }
        .section-label::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1); }

        .quest-list { list-style: none; display: flex; flex-direction: column; gap: 10px; padding: 0; margin: 0; }

        /* Quest Cards */
        .quest-card {
            background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            display: flex; align-items: center; gap: 12px;
            transition: all 0.2s;
            position: relative; overflow: hidden;
        }
        .quest-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); }
        
        /* Drag & Drop Styles */
        .quest-card.draggable {
            cursor: grab;
        }
        .quest-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
            border-color: #8b5cf6;
        }
        .quest-card.drag-over {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.15);
        }
        .drag-handle {
            cursor: grab;
            color: var(--text-muted);
            opacity: 0.4;
            transition: opacity 0.2s;
            padding: 4px;
        }
        .quest-card:hover .drag-handle {
            opacity: 1;
        }
        
        .quest-icon {
            width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; color: white; flex-shrink: 0;
        }
        .quest-details { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .quest-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .quest-reward { font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
        .highlight-xp { color: #fbbf24; font-weight: 700; }
        .highlight-penalty { color: #ef4444; font-weight: 700; }

        .quest-actions { display: flex; gap: 8px; flex-shrink: 0; }
        .action-play { 
            color: #4ade80; background: rgba(74, 222, 128, 0.15); width: 32px; height: 32px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; 
        }
        .action-play:hover { background: #4ade80; color: black; box-shadow: 0 0 10px #4ade80; }
        .action-del { color: #f87171; opacity: 0.5; cursor: pointer; padding: 5px; transition: 0.2s; }
        .action-del:hover { opacity: 1; transform: scale(1.1); }
        
        /* Restore button for completed tasks */
        .action-restore { 
            color: #fbbf24; background: rgba(251, 191, 36, 0.15); width: 28px; height: 28px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; 
            font-size: 0.7rem;
        }
        .action-restore:hover { background: #fbbf24; color: black; box-shadow: 0 0 10px #fbbf24; }

        .type-light .quest-icon { background: rgba(46, 204, 113, 0.2); color: #2ecc71; box-shadow: 0 0 10px rgba(46, 204, 113, 0.1); }
        .type-medium .quest-icon { background: rgba(241, 196, 15, 0.2); color: #f1c40f; box-shadow: 0 0 10px rgba(241, 196, 15, 0.1); }
        .type-heavy .quest-icon { background: rgba(239, 68, 68, 0.2); color: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.1); }

        /* History section styling */
        #history-list {
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        #history-list:hover {
            opacity: 1;
        }
        #history-list .quest-card {
            cursor: pointer;
        }

        /* --- BOTTOM CONTROLS --- */
        .bottom-hud {
            align-self: center; display: flex; flex-direction: column; align-items: center; gap: 20px; 
            margin-bottom: 40px; pointer-events: auto; width: 100%;
            transition: margin-bottom 0.3s ease;
        }
        
        /* Reduce bottom margin when timer is active (dock is hidden) */
        body.timer-active .bottom-hud {
            margin-bottom: 20px;
        }

        .hud-timer-panel {
            background: rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.1); border-top: 2px solid #8b5cf6;
            border-radius: var(--radius-lg); padding: 20px 40px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 300px;
        }
        .hud-timer-panel.hidden { display: none; }

        .timer-label { font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; }
        .timer-digits { font-size: 3.5rem; line-height: 1; font-weight: 700; font-variant-numeric: tabular-nums; 
            background: linear-gradient(180deg, #fff 0%, #aaa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        
        .timer-actions { display: flex; gap: 12px; margin-top: 15px; width: 100%; justify-content: center; }

        .btn-pill { padding: 8px 20px; border-radius: 50px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: all 0.2s; }
        .btn-finish { background: var(--primary-gradient); color: white; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); }
        .btn-finish:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6); }
        .btn-cancel { background: rgba(255,255,255,0.1); color: #ccc; }
        .btn-cancel:hover { background: rgba(255,255,255,0.2); color: white; }
        .btn-pause { background: var(--gold-gradient); color: #000; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
        .btn-pause:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6); }
        .btn-pause.paused { background: var(--blue-gradient); color: white; }
        .btn-pause.paused i::before { content: "\f04b"; } /* Play icon when paused */

        .dock {
            display: flex; gap: 12px; background: rgba(10, 10, 20, 0.7);
            border: 1px solid rgba(255,255,255,0.08); padding: 10px 16px; border-radius: 50px;
            backdrop-filter: blur(10px); transition: opacity 0.3s; flex-wrap: wrap; justify-content: center;
        }
        .dock.disabled { opacity: 0; pointer-events: none; transform: translateY(20px); }

        .dock-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.15); color: #ccc;
            padding: 10px 20px; border-radius: 30px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 8px; font-size: 0.85rem; transition: all 0.2s;
        }
        .dock-btn:hover { background: rgba(255,255,255,0.1); color: white; border-color: white; transform: translateY(-3px); }
        .dock-btn.start-light { border-color: #2ecc71; color: #2ecc71; }
        .dock-btn.start-light:hover { background: #2ecc71; color: #000; box-shadow: 0 0 15px rgba(46, 204, 113, 0.4); }
        .dock-btn.start-med { border-color: #f1c40f; color: #f1c40f; }
        .dock-btn.start-med:hover { background: #f1c40f; color: #000; box-shadow: 0 0 15px rgba(241, 196, 15, 0.4); }
        .dock-btn.start-heavy { border-color: #ef4444; color: #ef4444; }
        .dock-btn.start-heavy:hover { background: #ef4444; color: #000; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }
        .dock-btn.start-rest { border-color: #8b5cf6; color: #8b5cf6; }
        .dock-btn.start-rest:hover { background: #8b5cf6; color: white; box-shadow: 0 0 15px rgba(139, 92, 246, 0.4); }

        /* --- MODALS & OVERLAYS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal-card {
            background: #18181b; border: 1px solid #3f3f46;
            padding: 30px; border-radius: 24px;
            width: 400px; max-width: 90%; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            position: relative; overflow: hidden;
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.active .modal-card { transform: scale(1); }
        
        .modal-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        .modal-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 8px; background: linear-gradient(90deg, #fff, #ccc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .modal-desc { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 24px; line-height: 1.5; }

        .input-group { margin-bottom: 24px; text-align: left; }
        .styled-input {
            width: 100%; padding: 16px; border-radius: 12px; border: 1px solid #333;
            background: #09090b; color: white; font-size: 1rem; outline: none; transition: 0.2s;
        }
        .styled-input:focus { border-color: #8b5cf6; box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1); }

        .plan-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 24px; }
        .plan-option {
            background: #27272a; border: 1px solid #3f3f46; border-radius: 12px; padding: 15px 5px; cursor: pointer; transition: 0.2s; position: relative;
        }
        .plan-option:hover { background: #3f3f46; transform: translateY(-2px); }
        .plan-option h4 { font-size: 0.9rem; margin-bottom: 4px; }
        .plan-option p { font-size: 0.7rem; color: #888; margin: 0; }
        .plan-option i { font-size: 1.2rem; margin-bottom: 8px; display: block; }

        .btn-full { width: 100%; padding: 16px; border-radius: 16px; background: var(--primary-gradient); color: white; font-weight: 700; border: none; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-full:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4); }

        /* --- ADMIN PANEL --- */
        .admin-panel {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #111; border: 2px solid #ef4444; border-radius: 12px;
            padding: 20px; z-index: 1000; box-shadow: 0 0 50px rgba(239, 68, 68, 0.3);
            display: none; flex-direction: column; gap: 10px; min-width: 300px;
        }
        .admin-panel.active { display: flex; }
        .admin-header { color: #ef4444; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; text-align: center; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .admin-btn { background: #333; color: white; border: 1px solid #444; padding: 10px; cursor: pointer; border-radius: 6px; text-align: left; }
        .admin-btn:hover { background: #444; }
        .admin-btn small { display: block; color: #888; font-size: 0.7em; }

        /* Toasts */
        .toast-container { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); z-index: 200; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast {
            background: #18181b; border: 1px solid #333; color: white; padding: 12px 24px; border-radius: 50px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: floatUp 3s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .toast i { color: #f59e0b; }
        .toast.penalty i { color: #ef4444; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes floatUp { 0% { opacity: 0; transform: translateY(30px); } 10% { opacity: 1; transform: translateY(0); } 90% { opacity: 1; transform: translateY(-10px); } 100% { opacity: 0; transform: translateY(-20px); } }
        
        .drag-hint { position: absolute; bottom: 20px; left: 20px; color: rgba(255,255,255,0.2); font-size: 0.8rem; pointer-events: none; }
        .close-icon { position: absolute; top: 15px; right: 15px; cursor: pointer; opacity: 0.5; font-size: 1.2rem; }
        .close-icon:hover { opacity: 1; }

        /* Streak indicator */
        .streak-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Settings button */
        .settings-btn {
            position: absolute;
            bottom: 24px;
            right: 24px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
            backdrop-filter: blur(12px);
            z-index: 15;
        }
        .settings-btn:hover {
            background: rgba(139, 92, 246, 0.3);
            color: white;
            transform: rotate(45deg);
            border-color: #8b5cf6;
        }
        
        /* Theme selector grid */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .theme-option {
            aspect-ratio: 1;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            position: relative;
            overflow: hidden;
        }
        .theme-option::before {
            content: '';
            position: absolute;
            inset: 0;
            opacity: 0.3;
            z-index: 0;
        }
        .theme-option i, .theme-option span {
            position: relative;
            z-index: 1;
        }
        .theme-option i {
            font-size: 1.5rem;
        }
        .theme-option span {
            font-size: 0.7rem;
            font-weight: 600;
        }
        .theme-option:hover {
            transform: translateY(-3px);
        }
        .theme-option.selected {
            border-color: #8b5cf6;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
        }
        .theme-option.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .theme-option.locked::after {
            content: '\f023';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.7rem;
            color: #888;
        }
        
        /* Theme colors */
        .theme-forest { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); }
        .theme-forest i { color: #4ade80; }
        .theme-desert { background: linear-gradient(135deg, #92400e 0%, #451a03 100%); }
        .theme-desert i { color: #fbbf24; }
        .theme-snow { background: linear-gradient(135deg, #e0f2fe 0%, #7dd3fc 100%); }
        .theme-snow i { color: #0ea5e9; }
        .theme-snow span { color: #0c4a6e; }
        .theme-volcano { background: linear-gradient(135deg, #7f1d1d 0%, #1c0a0a 100%); }
        .theme-volcano i { color: #ef4444; }
        .theme-ocean { background: linear-gradient(135deg, #0c4a6e 0%, #082f49 100%); }
        .theme-ocean i { color: #22d3ee; }
        .theme-sakura { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); }
        .theme-sakura i { color: #ec4899; }
        .theme-sakura span { color: #9d174d; }
        .theme-nether { background: linear-gradient(135deg, #4c1d95 0%, #1e1b4b 100%); }
        .theme-nether i { color: #c084fc; }
        .theme-golden { background: linear-gradient(135deg, #fbbf24 0%, #b45309 100%); }
        .theme-golden i { color: #fff; }
        .theme-golden span { color: #78350f; }
        
        .unlock-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 10px;
        }

        /* Daily stats */
        .daily-stats {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .daily-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .daily-stat i {
            font-size: 0.8rem;
        }

        /* --- MEDIUM SCREEN (Tablet / Small Desktop) --- */
        @media (max-width: 1100px) and (min-width: 769px) {
            .quest-log {
                width: 300px;
                max-height: 45vh;
            }
            .quest-header {
                padding: 15px;
            }
            .quest-header h3 {
                font-size: 1rem;
            }
            .quest-content {
                padding: 12px;
            }
            .quest-card {
                padding: 10px 12px;
            }
            .quest-name {
                font-size: 0.85rem;
            }
            .quest-icon {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            .hud-timer-panel {
                min-width: 260px;
                padding: 15px 25px;
            }
            .timer-digits {
                font-size: 2.8rem;
            }
            .bottom-hud {
                margin-bottom: 20px;
            }
            body.timer-active .bottom-hud {
                margin-bottom: 15px;
            }
        }

        /* --- SMALLER MEDIUM SCREEN --- */
        @media (max-width: 900px) and (min-width: 769px) {
            .quest-log {
                width: 240px;
                max-height: 40vh;
                right: 16px;
                top: 24px;
            }
            .quest-header {
                padding: 12px;
            }
            .quest-card {
                padding: 8px 10px;
                gap: 8px;
            }
            .quest-icon {
                width: 30px;
                height: 30px;
                font-size: 0.85rem;
            }
            .action-play {
                width: 26px;
                height: 26px;
            }
            .drag-handle {
                display: none;
            }
            .hud-timer-panel {
                min-width: 240px;
                padding: 12px 20px;
            }
            .timer-digits {
                font-size: 2.5rem;
            }
            .timer-actions {
                gap: 8px;
                flex-wrap: wrap;
                justify-content: center;
            }
            .btn-pill {
                padding: 6px 14px;
                font-size: 0.8rem;
            }
        }

        /* --- MOBILE MEDIA QUERY --- */
        @media (max-width: 768px) {
            .hud { padding: 16px; }
            .stats-bar { min-width: 0; width: 100%; padding: 10px 15px; }
            .avatar-circle { width: 40px; height: 40px; font-size: 1rem; }
            .char-name { font-size: 0.85rem; }
            
            /* Hide the Desktop Quest Log completely */
            .quest-log { display: none; }
            
            /* Show Mobile Button */
            .mobile-quest-toggle { display: flex; }
            
            /* Settings button on mobile */
            .settings-btn {
                bottom: 16px;
                right: 16px;
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            /* Mobile Modal Styling */
            .mobile-modal-active .quest-log {
                display: flex;
                position: fixed;
                top: 0; left: 0; width: 100%; height: 100%;
                max-height: 100%; border-radius: 0;
                z-index: 200;
                border: none;
                background: rgba(10, 10, 20, 0.95);
            }
            
            /* Force content visible when modal active */
            .mobile-modal-active .quest-content {
                opacity: 1 !important;
                pointer-events: auto !important;
            }
            
            /* CSS UPDATE HERE: Extra padding for mobile header */
            .mobile-modal-active .quest-header {
                padding-top: 90px; /* Space for close button and status bar */
            }
            
            .mobile-modal-active .icon-btn.close-mobile { display: flex; position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); width: 40px; height: 40px; }
            
            .bottom-hud { margin-bottom: 20px; width: 100%; }
            .hud-timer-panel { min-width: 0; width: 100%; padding: 15px; }
            .timer-digits { font-size: 2.5rem; }
            
            .dock { gap: 8px; padding: 8px 12px; width: 100%; box-sizing: border-box; }
            .dock-btn { padding: 8px 12px; font-size: 0.75rem; flex: 1; justify-content: center; }
            
            .drag-hint { bottom: 100px; opacity: 0.5; font-size: 0.7rem; }
        }

    </style>
</head>
<body>

    <canvas id="game-canvas"></canvas>
    <div class="drag-hint"><i class="fas fa-hand-pointer"></i> Drag to rotate camera</div>
    
    <!-- Settings Button -->
    <button class="settings-btn hud__interactive" onclick="rpgSystem.openThemeSelector()" title="Customize World">
        <i class="fas fa-palette"></i>
    </button>

    <!-- ADMIN PANEL -->
    <div class="admin-panel" id="admin-panel">
        <div class="admin-header">Admin Control</div>
        <button class="admin-btn" onclick="rpgSystem.admin.addXP(500)">
            <i class="fas fa-plus"></i> Add 500 XP
            <small>Instant XP Boost</small>
        </button>
        <button class="admin-btn" onclick="rpgSystem.admin.forceLevelUp()">
            <i class="fas fa-arrow-up"></i> Force Level Up
            <small>Triggers animation & reset</small>
        </button>
        <button class="admin-btn" onclick="rpgSystem.admin.fillStamina()">
            <i class="fas fa-bolt"></i> Fill Stamina
            <small>Set to 100%</small>
        </button>
        <button class="admin-btn" onclick="rpgSystem.admin.drainStamina()">
            <i class="fas fa-battery-empty"></i> Drain Stamina
            <small>Set to 5% (Test Low Power)</small>
        </button>
        <button class="admin-btn" onclick="rpgSystem.admin.resetAll()">
            <i class="fas fa-redo"></i> Reset Progress
            <small>Clear all data</small>
        </button>
        <button class="admin-btn" onclick="document.getElementById('admin-panel').classList.remove('active')">
            Close Panel
        </button>
    </div>

    <!-- HUD -->
    <div class="hud">
        <!-- Top Stats Bar & Mobile Toggle -->
        <div class="stats-container hud__interactive">
            <div class="stats-bar">
                <div class="avatar-circle" onclick="rpgSystem.admin.clickTrigger()">
                    <i class="fas fa-user-astronaut"></i>
                </div>
                <div class="stat-group">
                    <div class="char-name">
                        <span id="char-name-display">Player One</span>
                        <span class="streak-badge" id="streak-badge" style="display:none;">
                            <i class="fas fa-fire-flame-curved"></i>
                            <span id="streak-count">0</span>
                        </span>
                    </div>
                    <div class="resource-row">
                        <div style="width: 20px; text-align:center; color:#fbbf24;"><i class="fas fa-crown"></i></div>
                        <div class="bar-wrapper">
                            <div class="bar-label"><span>Level <span id="level-val">1</span></span><span style="font-weight:400; opacity:0.7;"><span id="xp-current">0</span> XP</span></div>
                            <div class="progress-track"><div class="progress-fill xp-fill" id="xp-bar" style="width: 0%"></div></div>
                        </div>
                    </div>
                    <div class="resource-row">
                        <div style="width: 20px; text-align:center; color:#8b5cf6;"><i class="fas fa-bolt"></i></div>
                        <div class="bar-wrapper">
                            <div class="bar-label"><span>Focus Energy</span></div>
                            <div class="progress-track"><div class="progress-fill stamina-fill" id="stamina-bar" style="width: 100%"></div></div>
                        </div>
                    </div>
                    <div class="daily-stats">
                        <div class="daily-stat"><i class="fas fa-check-circle" style="color:#4ade80;"></i> <span id="daily-completed">0</span> today</div>
                        <div class="daily-stat"><i class="fas fa-clock" style="color:#8b5cf6;"></i> <span id="total-focus-time">0</span>m focused</div>
                    </div>
                </div>
            </div>
            
            <!-- MOBILE QUEST TOGGLE BUTTON -->
            <div class="mobile-quest-toggle" onclick="rpgSystem.toggleMobileQuestModal()">
                <span><i class="fas fa-scroll"></i> Quest Board</span>
                <span style="background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:4px; font-size:0.8rem;" id="active-quest-count">0</span>
            </div>
        </div>

        <!-- Quest Log (Sidebar on Desktop / Modal on Mobile) -->
        <div class="quest-log hud__interactive" id="quest-log-panel">
            <button class="icon-btn close-mobile" onclick="rpgSystem.toggleMobileQuestModal()"><i class="fas fa-times"></i></button>
            <div class="quest-header">
                <h3><i class="fas fa-scroll" style="color:#d946ef"></i> Active Quests</h3>
                <div class="header-actions">
                    <button class="icon-btn" onclick="event.stopPropagation(); rpgSystem.openPlanner()"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            
            <div class="quest-content">
                <div class="section-label">Quest Board <span style="opacity:0.5; font-size:0.65rem; margin-left:4px;">(drag to reorder)</span></div>
                <div class="quest-list" id="planned-list">
                    <!-- Dynamic Items -->
                </div>

                <div class="section-label" style="margin-top:10px;">Completions <span style="opacity:0.5; font-size:0.65rem; margin-left:4px;">(click to restore)</span></div>
                <div class="quest-list" id="history-list">
                    <!-- History Items -->
                </div>
            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="bottom-hud">
            <!-- TIMER PANEL -->
            <div id="hud-timer-panel" class="hud-timer-panel hidden">
                <div id="hud-timer-label" class="timer-label">Current Task</div>
                <div id="hud-timer-val" class="timer-digits">25:00</div>
                <div class="timer-actions">
                    <button class="btn-pill btn-cancel" onclick="rpgSystem.cancelAction()" title="Stop and return task to queue"><i class="fas fa-times"></i> Stop</button>
                    <button id="hud-pause-btn" class="btn-pill btn-pause" onclick="rpgSystem.togglePause()"><i class="fas fa-pause"></i> Pause</button>
                    <button id="hud-finish-btn" class="btn-pill btn-finish" onclick="rpgSystem.finishAction()"><i class="fas fa-check"></i> Complete</button>
                </div>
            </div>

            <!-- DOCK CONTROLS -->
            <div class="dock hud__interactive" id="controls-bar">
                <button class="dock-btn start-light" onclick="rpgSystem.quickStart('light')"><i class="fas fa-seedling"></i> 5m</button>
                <button class="dock-btn start-med" onclick="rpgSystem.quickStart('medium')"><i class="fas fa-fire"></i> 15m</button>
                <button class="dock-btn start-heavy" onclick="rpgSystem.quickStart('heavy')"><i class="fas fa-dragon"></i> 25m</button>
                <div style="width:1px; background:rgba(255,255,255,0.2); height:20px; margin:0 5px;"></div>
                <button class="dock-btn start-rest" onclick="rpgSystem.startRest()"><i class="fas fa-moon"></i> Rest</button>
            </div>
        </div>
    </div>

    <!-- OVERLAYS (Login, Planner) -->
    <div class="modal-overlay active" id="login-overlay">
        <div class="modal-card">
            <div class="icon-circle" style="font-size: 3rem; margin-bottom: 20px; background: -webkit-linear-gradient(#8b5cf6, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"><i class="fas fa-dungeon"></i></div>
            <h2 class="modal-title">RPG Pomodoro</h2>
            <p class="modal-desc">Enter the realm of focus. Complete tasks to level up.</p>
            <div class="input-group"><input type="text" class="styled-input" id="char-name-input" placeholder="Character Name..." autocomplete="off"></div>
            <button class="btn-full" onclick="startGame()">Enter World <i class="fas fa-arrow-right" style="margin-left:8px;"></i></button>
        </div>
    </div>

    <div class="modal-overlay" id="planner-modal">
        <div class="modal-card">
            <i class="fas fa-times close-icon" onclick="document.getElementById('planner-modal').classList.remove('active')"></i>
            <h2 class="modal-title">New Quest</h2>
            <div class="input-group"><input type="text" class="styled-input" id="plan-input" placeholder="e.g. Fix Bug..." autocomplete="off"></div>
            <div class="plan-grid">
                <div class="plan-option" onclick="rpgSystem.addPlannedTask('light')"><i class="fas fa-seedling" style="color:#2ecc71;"></i><h4>Light</h4><p>5 min</p></div>
                <div class="plan-option" onclick="rpgSystem.addPlannedTask('medium')"><i class="fas fa-fire" style="color:#f1c40f;"></i><h4>Medium</h4><p>15 min</p></div>
                <div class="plan-option" onclick="rpgSystem.addPlannedTask('heavy')"><i class="fas fa-dragon" style="color:#ef4444;"></i><h4>Heavy</h4><p>25 min</p></div>
            </div>
        </div>
    </div>

    <!-- Restore Confirmation Modal -->
    <div class="modal-overlay" id="restore-modal">
        <div class="modal-card">
            <i class="fas fa-times close-icon" onclick="document.getElementById('restore-modal').classList.remove('active')"></i>
            <h2 class="modal-title">Restore Quest?</h2>
            <p class="modal-desc" id="restore-desc">Restoring this quest will cost you XP as a penalty.</p>
            <div style="display:flex; gap:12px; justify-content:center;">
                <button class="btn-pill btn-cancel" onclick="document.getElementById('restore-modal').classList.remove('active')">Cancel</button>
                <button class="btn-pill btn-finish" id="restore-confirm-btn" style="background: var(--danger-gradient);"><i class="fas fa-undo"></i> Restore (-XP)</button>
            </div>
        </div>
    </div>
    
    <!-- Theme Selector Modal -->
    <div class="modal-overlay" id="theme-modal">
        <div class="modal-card">
            <i class="fas fa-times close-icon" onclick="document.getElementById('theme-modal').classList.remove('active')"></i>
            <h2 class="modal-title"><i class="fas fa-palette" style="margin-right:8px;"></i>World Theme</h2>
            <p class="modal-desc">Choose your landscape. Unlock more by leveling up!</p>
            <div class="theme-grid" id="theme-grid">
                <!-- Filled by JS -->
            </div>
            <p class="unlock-hint" id="unlock-hint"></p>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- GAME LOGIC ---
        const gameState = { 
            name: "Dev", 
            level: 1, 
            xp: 0, 
            xpToNext: 1000, 
            stamina: 100, 
            plannedTasks: [], 
            completedTasks: [], 
            activeTask: null, 
            timerInterval: null,
            // Timer state
            isPaused: false,
            timeLeft: 0,
            // New stats
            streak: 0,
            lastCompletedDate: null,
            dailyCompleted: 0,
            totalFocusTime: 0,
            // Theme
            currentTheme: 'forest'
        };
        const gearUnlocks = { 2: "Magic Staff", 3: "Mystic Cape", 5: "Crown of Focus", 10: "God Mode Aura" };
        const taskDefinitions = { light: { t: "Light", m: 5, x: 50, s: 5, icon: "fa-seedling" }, medium: { t: "Medium", m: 15, x: 150, s: 15, icon: "fa-fire" }, heavy: { t: "Heavy", m: 25, x: 500, s: 30, icon: "fa-dragon" } };
        
        // Theme definitions
        const themes = {
            forest: {
                name: "Mystic Forest",
                icon: "fa-tree",
                unlockLevel: 1,
                sky: 0x1e1b4b,
                fog: 0x1e1b4b,
                ground: 0x0f172a,
                tree: 0x1e1b4b,
                leaves: 0x334155,
                rock: 0x1e293b,
                particles: 0xc084fc
            },
            desert: {
                name: "Amber Dunes",
                icon: "fa-sun",
                unlockLevel: 2,
                sky: 0x451a03,
                fog: 0x78350f,
                ground: 0x92400e,
                tree: 0x78350f,
                leaves: 0xd97706,
                rock: 0xa16207,
                particles: 0xfbbf24
            },
            snow: {
                name: "Frozen Peaks",
                icon: "fa-snowflake",
                unlockLevel: 3,
                sky: 0x0c4a6e,
                fog: 0x7dd3fc,
                ground: 0xe0f2fe,
                tree: 0x164e63,
                leaves: 0xcffafe,
                rock: 0x94a3b8,
                particles: 0x7dd3fc
            },
            volcano: {
                name: "Volcanic Wastes",
                icon: "fa-fire-flame-curved",
                unlockLevel: 4,
                sky: 0x1c0a0a,
                fog: 0x450a0a,
                ground: 0x1c0a0a,
                tree: 0x292524,
                leaves: 0x44403c,
                rock: 0x7f1d1d,
                particles: 0xef4444
            },
            ocean: {
                name: "Deep Ocean",
                icon: "fa-water",
                unlockLevel: 5,
                sky: 0x082f49,
                fog: 0x0c4a6e,
                ground: 0x164e63,
                tree: 0x134e4a,
                leaves: 0x2dd4bf,
                rock: 0x115e59,
                particles: 0x22d3ee
            },
            sakura: {
                name: "Cherry Blossom",
                icon: "fa-fan",
                unlockLevel: 6,
                sky: 0xfce7f3,
                fog: 0xfbcfe8,
                ground: 0x4a044e,
                tree: 0x581c87,
                leaves: 0xf9a8d4,
                rock: 0x86198f,
                particles: 0xec4899
            },
            nether: {
                name: "Shadow Realm",
                icon: "fa-ghost",
                unlockLevel: 8,
                sky: 0x0f0520,
                fog: 0x1e1b4b,
                ground: 0x0f0520,
                tree: 0x2e1065,
                leaves: 0x7c3aed,
                rock: 0x4c1d95,
                particles: 0xc084fc
            },
            golden: {
                name: "Golden Paradise",
                icon: "fa-crown",
                unlockLevel: 10,
                sky: 0x78350f,
                fog: 0xb45309,
                ground: 0x451a03,
                tree: 0x92400e,
                leaves: 0xfbbf24,
                rock: 0xfbbf24,
                particles: 0xfef08a
            }
        };

        // Drag & Drop state
        let draggedElement = null;
        let draggedTaskId = null;

        const rpgSystem = {
            admin: {
                clicks: 0, clickTimer: null,
                clickTrigger: () => {
                    rpgSystem.admin.clicks++; if(rpgSystem.admin.clicks >= 5) { rpgSystem.admin.clicks = 0; document.getElementById('admin-panel').classList.toggle('active'); rpgSystem.showToast("Admin Mode Active", "fa-user-secret"); }
                    clearTimeout(rpgSystem.admin.clickTimer); rpgSystem.admin.clickTimer = setTimeout(() => { rpgSystem.admin.clicks = 0; }, 500);
                },
                addXP: (amount) => { rpgSystem.showToast(`Admin: +${amount} XP`); gameState.xp += amount; if(gameState.xp >= gameState.xpToNext) rpgSystem.levelUp(); rpgSystem.updateUI(); },
                forceLevelUp: () => { rpgSystem.showToast("Admin: Level Up"); gameState.xp = gameState.xpToNext; rpgSystem.levelUp(); },
                fillStamina: () => { rpgSystem.showToast("Admin: Full Stamina"); gameState.stamina = 100; rpgSystem.updateUI(); },
                drainStamina: () => { rpgSystem.showToast("Admin: Drained"); gameState.stamina = 5; rpgSystem.updateUI(); },
                resetAll: () => {
                    if(confirm('Reset all progress? This cannot be undone!')) {
                        localStorage.removeItem('rpgPomodoroSave');
                        location.reload();
                    }
                }
            },

            updateUI: () => {
                document.getElementById('char-name-display').innerText = gameState.name;
                document.getElementById('level-val').innerText = gameState.level;
                document.getElementById('xp-current').innerText = gameState.xp;
                const xpPercent = (gameState.xp / gameState.xpToNext) * 100;
                document.getElementById('xp-bar').style.width = `${xpPercent}%`;
                const stamBar = document.getElementById('stamina-bar');
                stamBar.style.width = `${gameState.stamina}%`;
                if (gameState.stamina < 30) stamBar.classList.add('low'); else stamBar.classList.remove('low');
                if (typeof scene !== 'undefined' && scene && scene.fog) {
                    scene.fog.color.setHex(gameState.stamina < 30 ? 0x000000 : 0x1e1b4b);
                    scene.fog.density = gameState.stamina < 30 ? 0.08 : 0.02;
                }
                
                // Streak badge
                const streakBadge = document.getElementById('streak-badge');
                if (gameState.streak > 0) {
                    streakBadge.style.display = 'inline-flex';
                    document.getElementById('streak-count').innerText = gameState.streak;
                } else {
                    streakBadge.style.display = 'none';
                }
                
                // Daily stats
                document.getElementById('daily-completed').innerText = gameState.dailyCompleted;
                document.getElementById('total-focus-time').innerText = gameState.totalFocusTime;
                
                document.getElementById('active-quest-count').innerText = gameState.plannedTasks.length;
                rpgSystem.renderBoards();
                updateWizardGear();
                rpgSystem.saveGame();
            },

            renderBoards: () => {
                const pList = document.getElementById('planned-list'); pList.innerHTML = '';
                if(gameState.plannedTasks.length === 0) pList.innerHTML = `<div style="text-align:center; padding:10px; color:#555; font-size:0.7rem;">No active quests</div>`;
                gameState.plannedTasks.forEach((t, index) => {
                    const def = taskDefinitions[t.type];
                    const div = document.createElement('div'); 
                    div.className = `quest-card type-${t.type} draggable`;
                    div.draggable = true;
                    div.dataset.taskId = t.id;
                    div.dataset.index = index;
                    div.innerHTML = `
                        <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                        <div class="quest-icon"><i class="fas ${def.icon}"></i></div>
                        <div class="quest-details">
                            <div class="quest-name">${t.title}</div>
                            <div class="quest-reward"><span class="highlight-xp">+${def.x} XP</span> â€¢ ${def.m} min</div>
                        </div>
                        <div class="quest-actions">
                            <div class="action-play" onclick="rpgSystem.startPlannedTask(${t.id})"><i class="fas fa-play" style="font-size:0.7rem;"></i></div>
                            <div class="action-del" onclick="rpgSystem.deletePlannedTask(${t.id})"><i class="fas fa-trash"></i></div>
                        </div>`;
                    
                    // Drag events
                    div.addEventListener('dragstart', rpgSystem.handleDragStart);
                    div.addEventListener('dragend', rpgSystem.handleDragEnd);
                    div.addEventListener('dragover', rpgSystem.handleDragOver);
                    div.addEventListener('dragenter', rpgSystem.handleDragEnter);
                    div.addEventListener('dragleave', rpgSystem.handleDragLeave);
                    div.addEventListener('drop', rpgSystem.handleDrop);
                    
                    pList.appendChild(div);
                });
                
                // History list with restore functionality
                const hList = document.getElementById('history-list'); hList.innerHTML = '';
                if(gameState.completedTasks.length === 0) {
                    hList.innerHTML = `<div style="text-align:center; padding:10px; color:#555; font-size:0.7rem;">No completions yet</div>`;
                }
                gameState.completedTasks.slice(-5).reverse().forEach((t, index) => {
                    const def = taskDefinitions[t.type];
                    const penalty = Math.floor(def.x * 0.5); // 50% XP penalty
                    const div = document.createElement('div'); 
                    div.className = `quest-card type-${t.type}`;
                    div.innerHTML = `
                        <div class="quest-icon"><i class="fas fa-check"></i></div>
                        <div class="quest-details">
                            <div class="quest-name" style="text-decoration:line-through; opacity:0.7;">${t.title}</div>
                            <div class="quest-reward">
                                <span class="highlight-penalty">-${penalty} XP to restore</span>
                            </div>
                        </div>
                        <div class="quest-actions">
                            <div class="action-restore" onclick="rpgSystem.confirmRestore(${t.id}, '${t.title}', ${penalty})" title="Restore quest (-${penalty} XP)">
                                <i class="fas fa-undo"></i>
                            </div>
                        </div>`;
                    hList.appendChild(div);
                });
            },

            // Drag & Drop handlers
            handleDragStart: (e) => {
                draggedElement = e.currentTarget;
                draggedTaskId = parseInt(e.currentTarget.dataset.taskId);
                e.currentTarget.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedTaskId);
            },
            
            handleDragEnd: (e) => {
                e.currentTarget.classList.remove('dragging');
                document.querySelectorAll('.quest-card').forEach(card => {
                    card.classList.remove('drag-over');
                });
                draggedElement = null;
                draggedTaskId = null;
            },
            
            handleDragOver: (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            },
            
            handleDragEnter: (e) => {
                e.preventDefault();
                if (e.currentTarget !== draggedElement && e.currentTarget.classList.contains('draggable')) {
                    e.currentTarget.classList.add('drag-over');
                }
            },
            
            handleDragLeave: (e) => {
                e.currentTarget.classList.remove('drag-over');
            },
            
            handleDrop: (e) => {
                e.preventDefault();
                e.currentTarget.classList.remove('drag-over');
                
                if (e.currentTarget === draggedElement) return;
                
                const fromId = draggedTaskId;
                const toId = parseInt(e.currentTarget.dataset.taskId);
                
                const fromIndex = gameState.plannedTasks.findIndex(t => t.id === fromId);
                const toIndex = gameState.plannedTasks.findIndex(t => t.id === toId);
                
                if (fromIndex !== -1 && toIndex !== -1) {
                    // Swap tasks
                    const [movedTask] = gameState.plannedTasks.splice(fromIndex, 1);
                    gameState.plannedTasks.splice(toIndex, 0, movedTask);
                    rpgSystem.updateUI();
                    rpgSystem.showToast("Quest order updated", "fa-arrows-alt");
                }
            },

            // Restore functionality
            confirmRestore: (id, title, penalty) => {
                const modal = document.getElementById('restore-modal');
                document.getElementById('restore-desc').innerHTML = `
                    Restoring "<strong>${title}</strong>" will cost you <span style="color:#ef4444; font-weight:700;">${penalty} XP</span> as a penalty.<br><br>
                    Your current XP: ${gameState.xp}
                `;
                document.getElementById('restore-confirm-btn').onclick = () => {
                    rpgSystem.restoreTask(id, penalty);
                    modal.classList.remove('active');
                };
                modal.classList.add('active');
            },
            
            restoreTask: (id, penalty) => {
                const taskIndex = gameState.completedTasks.findIndex(t => t.id === id);
                if (taskIndex === -1) return;
                
                const task = gameState.completedTasks[taskIndex];
                
                // Apply XP penalty
                gameState.xp = Math.max(0, gameState.xp - penalty);
                
                // Move task back to planned
                gameState.completedTasks.splice(taskIndex, 1);
                gameState.plannedTasks.push({
                    id: Date.now(), // New ID
                    title: task.title,
                    type: task.type,
                    xp: taskDefinitions[task.type].x,
                    cost: taskDefinitions[task.type].s,
                    duration: taskDefinitions[task.type].m * 60
                });
                
                rpgSystem.showToast(`Quest restored! -${penalty} XP`, "fa-undo", true);
                rpgSystem.updateUI();
            },

            toggleMobileQuestModal: () => {
                document.body.classList.toggle('mobile-modal-active');
            },

            openPlanner: () => {
                // If on mobile, close the quest modal first so planner modal can show
                if(window.innerWidth <= 768) document.body.classList.remove('mobile-modal-active');
                document.getElementById('plan-input').value = ""; document.getElementById('planner-modal').classList.add('active'); document.getElementById('plan-input').focus();
            },

            addPlannedTask: (type) => {
                const title = document.getElementById('plan-input').value || `${type.charAt(0).toUpperCase() + type.slice(1)} Task`;
                const newTask = { id: Date.now(), title: title, type: type, xp: taskDefinitions[type].x, cost: taskDefinitions[type].s, duration: taskDefinitions[type].m * 60 };
                gameState.plannedTasks.push(newTask);
                document.getElementById('planner-modal').classList.remove('active');
                rpgSystem.updateUI();
                rpgSystem.showToast("Quest Added", "fa-scroll");
            },

            deletePlannedTask: (id) => { gameState.plannedTasks = gameState.plannedTasks.filter(t => t.id !== id); rpgSystem.updateUI(); },

            startPlannedTask: (id) => {
                const task = gameState.plannedTasks.find(t => t.id === id); if (!task) return;
                if (gameState.stamina <= 10) return rpgSystem.showToast("Rest needed!", "fa-battery-empty");
                gameState.activeTask = { ...task }; gameState.plannedTasks = gameState.plannedTasks.filter(t => t.id !== id);
                rpgSystem.updateUI(); 
                if(window.innerWidth <= 768) document.body.classList.remove('mobile-modal-active'); // Close modal on start
                rpgSystem.initTimerUI(false);
            },

            quickStart: (type) => {
                if (gameState.stamina <= 10) return rpgSystem.showToast("Rest needed!", "fa-battery-empty");
                const def = taskDefinitions[type]; gameState.activeTask = { title: "Quick Quest", type, xp: def.x, cost: def.s, duration: def.m * 60 };
                rpgSystem.initTimerUI(false);
            },

            startRest: () => { gameState.activeTask = { type: 'rest', xp: 0, cost: 0, duration: 5 * 60, title: "Mana Recharge" }; rpgSystem.initTimerUI(true); },

            initTimerUI: (isRest) => {
                document.getElementById('controls-bar').classList.add('disabled'); 
                document.getElementById('hud-timer-panel').classList.remove('hidden');
                document.body.classList.add('timer-active'); // Add class for responsive styling
                
                // Reset pause state
                gameState.isPaused = false;
                const pauseBtn = document.getElementById('hud-pause-btn');
                pauseBtn.classList.remove('paused');
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                
                if (isRest) { 
                    document.getElementById('hud-timer-label').innerText = "MEDITATING..."; 
                    document.getElementById('hud-finish-btn').style.display = 'none'; 
                    pauseBtn.style.display = 'none'; // No pause during rest
                    startWizardRest(true); 
                } else { 
                    document.getElementById('hud-timer-label').innerText = gameState.activeTask.title; 
                    document.getElementById('hud-finish-btn').style.display = 'flex'; 
                    pauseBtn.style.display = 'flex';
                    startWizardFocus(true); 
                }
                
                gameState.timeLeft = gameState.activeTask.duration; 
                updateTimerDisplay(gameState.timeLeft);
                
                if (gameState.timerInterval) clearInterval(gameState.timerInterval);
                gameState.timerInterval = setInterval(() => { 
                    if (!gameState.isPaused) {
                        gameState.timeLeft--; 
                        updateTimerDisplay(gameState.timeLeft); 
                        if (gameState.timeLeft <= 0) { 
                            clearInterval(gameState.timerInterval); 
                            rpgSystem.finishAction(); 
                        }
                    }
                }, 1000);
            },
            
            togglePause: () => {
                gameState.isPaused = !gameState.isPaused;
                const pauseBtn = document.getElementById('hud-pause-btn');
                const timerLabel = document.getElementById('hud-timer-label');
                
                if (gameState.isPaused) {
                    pauseBtn.classList.add('paused');
                    pauseBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
                    timerLabel.innerText = "PAUSED - " + gameState.activeTask.title;
                    startWizardFocus(false); // Wizard stops focusing animation
                    rpgSystem.showToast("Timer paused", "fa-pause");
                } else {
                    pauseBtn.classList.remove('paused');
                    pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                    timerLabel.innerText = gameState.activeTask.title;
                    startWizardFocus(true); // Resume wizard animation
                    rpgSystem.showToast("Timer resumed", "fa-play");
                }
            },

            finishAction: () => {
                if (gameState.timerInterval) clearInterval(gameState.timerInterval); const task = gameState.activeTask;
                document.getElementById('hud-timer-panel').classList.add('hidden'); 
                document.getElementById('controls-bar').classList.remove('disabled');
                document.body.classList.remove('timer-active'); // Remove class
                startWizardFocus(false); startWizardRest(false);
                if (task.type === 'rest') { gameState.stamina = 100; rpgSystem.showToast("Mana Restored Full", "fa-bolt"); }
                else {
                    gameState.stamina = Math.max(0, gameState.stamina - task.cost); gameState.xp += task.xp;
                    gameState.completedTasks.push({ id: Date.now(), title: task.title, xp: task.xp, type: task.type }); 
                    
                    // Update daily stats
                    const today = new Date().toDateString();
                    if (gameState.lastCompletedDate !== today) {
                        // Check streak
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        if (gameState.lastCompletedDate === yesterday.toDateString()) {
                            gameState.streak++;
                        } else if (gameState.lastCompletedDate !== today) {
                            gameState.streak = 1;
                        }
                        gameState.dailyCompleted = 1;
                        gameState.lastCompletedDate = today;
                    } else {
                        gameState.dailyCompleted++;
                    }
                    
                    // Add focus time
                    gameState.totalFocusTime += taskDefinitions[task.type].m;
                    
                    rpgSystem.showToast(`Quest Complete! +${task.xp} XP`, "fa-check-circle");
                    if(elements.wizardGroup) { elements.wizardGroup.position.y += 1; const flash = new THREE.PointLight(0xffffff, 2, 10); flash.position.set(0,2,0); scene.add(flash); setTimeout(() => scene.remove(flash), 200); }
                    if (gameState.xp >= gameState.xpToNext) rpgSystem.levelUp();
                }
                rpgSystem.updateUI();
            },

            cancelAction: () => {
                if (gameState.timerInterval) clearInterval(gameState.timerInterval);
                document.getElementById('hud-timer-panel').classList.add('hidden'); 
                document.getElementById('controls-bar').classList.remove('disabled');
                document.body.classList.remove('timer-active'); // Remove class
                startWizardFocus(false); startWizardRest(false);
                
                // Return task to queue (not for rest)
                const task = gameState.activeTask;
                if (task && task.type !== 'rest') {
                    // Add back to planned tasks at the beginning
                    gameState.plannedTasks.unshift({
                        id: Date.now(),
                        title: task.title,
                        type: task.type,
                        xp: task.xp,
                        cost: task.cost,
                        duration: task.duration
                    });
                    rpgSystem.showToast("Task returned to queue", "fa-undo");
                } else {
                    rpgSystem.showToast("Rest cancelled", "fa-ban");
                }
                
                gameState.activeTask = null;
                gameState.isPaused = false;
                rpgSystem.updateUI();
            },

            levelUp: () => {
                gameState.level++; gameState.xp -= gameState.xpToNext; gameState.xpToNext = Math.floor(gameState.xpToNext * 1.3);
                rpgSystem.showToast(`Level Up! Lvl ${gameState.level}`, "fa-level-up-alt");
                if(gearUnlocks[gameState.level]) setTimeout(() => rpgSystem.showToast(`Unbox: ${gearUnlocks[gameState.level]}`, "fa-box-open"), 1500);
                rpgSystem.updateUI();
            },

            showToast: (msg, icon, isPenalty = false) => {
                const div = document.createElement('div'); 
                div.className = `toast${isPenalty ? ' penalty' : ''}`; 
                div.innerHTML = `<i class="fas ${icon || 'fa-info-circle'}"></i> ${msg}`;
                document.getElementById('toast-container').appendChild(div); 
                setTimeout(() => div.remove(), 3000);
            },
            
            // Theme selector
            openThemeSelector: () => {
                const grid = document.getElementById('theme-grid');
                grid.innerHTML = '';
                
                let nextUnlock = null;
                
                Object.entries(themes).forEach(([key, theme]) => {
                    const isUnlocked = gameState.level >= theme.unlockLevel;
                    const isSelected = gameState.currentTheme === key;
                    
                    if (!isUnlocked && !nextUnlock) {
                        nextUnlock = theme;
                    }
                    
                    const div = document.createElement('div');
                    div.className = `theme-option theme-${key}${isSelected ? ' selected' : ''}${!isUnlocked ? ' locked' : ''}`;
                    div.innerHTML = `<i class="fas ${theme.icon}"></i><span>${theme.name}</span>`;
                    
                    if (isUnlocked) {
                        div.onclick = () => rpgSystem.selectTheme(key);
                    } else {
                        div.title = `Unlock at Level ${theme.unlockLevel}`;
                    }
                    
                    grid.appendChild(div);
                });
                
                // Show unlock hint
                const hint = document.getElementById('unlock-hint');
                if (nextUnlock) {
                    hint.innerHTML = `<i class="fas fa-lock"></i> Next unlock: <strong>${nextUnlock.name}</strong> at Level ${nextUnlock.unlockLevel}`;
                } else {
                    hint.innerHTML = `<i class="fas fa-star"></i> All themes unlocked! You're a true focus master.`;
                }
                
                document.getElementById('theme-modal').classList.add('active');
            },
            
            selectTheme: (themeKey) => {
                gameState.currentTheme = themeKey;
                rpgSystem.applyTheme(themeKey);
                rpgSystem.saveGame();
                rpgSystem.showToast(`Theme: ${themes[themeKey].name}`, themes[themeKey].icon);
                document.getElementById('theme-modal').classList.remove('active');
            },
            
            applyTheme: (themeKey) => {
                const theme = themes[themeKey];
                if (!scene) return;
                
                // Update fog
                scene.fog.color.setHex(theme.fog);
                
                // Update background
                document.getElementById('game-canvas').style.background = 
                    `radial-gradient(circle at center, #${theme.sky.toString(16).padStart(6, '0')} 0%, #000000 100%)`;
                
                // Update ground
                if (elements.ground) {
                    elements.ground.material.color.setHex(theme.ground);
                }
                
                // Update trees and rocks
                scene.children.forEach(obj => {
                    if (obj.userData && obj.userData.isTree) {
                        obj.material.color.setHex(theme.tree);
                        if (obj.children[0]) {
                            obj.children[0].material.color.setHex(theme.leaves);
                        }
                    }
                    if (obj.userData && obj.userData.isRock) {
                        obj.material.color.setHex(theme.rock);
                    }
                });
                
                // Update particles
                if (elements.particles) {
                    elements.particles.material.color.setHex(theme.particles);
                }
            },
            
            // Save/Load game
            saveGame: () => {
                const saveData = {
                    name: gameState.name,
                    level: gameState.level,
                    xp: gameState.xp,
                    xpToNext: gameState.xpToNext,
                    stamina: gameState.stamina,
                    plannedTasks: gameState.plannedTasks,
                    completedTasks: gameState.completedTasks,
                    streak: gameState.streak,
                    lastCompletedDate: gameState.lastCompletedDate,
                    dailyCompleted: gameState.dailyCompleted,
                    totalFocusTime: gameState.totalFocusTime,
                    currentTheme: gameState.currentTheme
                };
                localStorage.setItem('rpgPomodoroSave', JSON.stringify(saveData));
            },
            
            loadGame: () => {
                const saved = localStorage.getItem('rpgPomodoroSave');
                if (saved) {
                    const data = JSON.parse(saved);
                    Object.assign(gameState, data);
                    
                    // Check if daily stats need reset (new day)
                    const today = new Date().toDateString();
                    if (gameState.lastCompletedDate !== today) {
                        // Check if streak should be reset
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        if (gameState.lastCompletedDate !== yesterday.toDateString()) {
                            gameState.streak = 0;
                        }
                        gameState.dailyCompleted = 0;
                    }
                    
                    return true;
                }
                return false;
            }
        };

        function updateTimerDisplay(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0'); const s = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('hud-timer-val').innerText = `${m}:${s}`;
        }

        // --- 3D ENGINE ---
        let scene, camera, renderer, elements = {}; let spinSpeed = 1; let isFocusing = false;
        let cameraAngle = 0; const cameraRadius = 13; let isDragging = false; let previousMouseX = 0;

        function initWorld() {
            const theme = themes[gameState.currentTheme];
            scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(theme.fog, 0.02);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            
            // Standard centered view
            camera.position.set(0, 4, 13);
            camera.lookAt(0, 2, 0);

            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('game-canvas'), antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight); renderer.shadowMap.enabled = true;

            const canvas = document.getElementById('game-canvas');
            canvas.addEventListener('mousedown', (e) => { isDragging = true; previousMouseX = e.clientX; canvas.classList.add('grabbing'); });
            window.addEventListener('touchstart', (e) => { isDragging = true; previousMouseX = e.touches[0].clientX; }, {passive: false});
            window.addEventListener('mousemove', (e) => { if (isDragging) { cameraAngle -= (e.clientX - previousMouseX) * 0.005; updateCameraPosition(); previousMouseX = e.clientX; } });
            window.addEventListener('touchmove', (e) => { if (isDragging) { cameraAngle -= (e.touches[0].clientX - previousMouseX) * 0.005; updateCameraPosition(); previousMouseX = e.touches[0].clientX; } }, {passive: false});
            window.addEventListener('mouseup', () => { isDragging = false; canvas.classList.remove('grabbing'); });
            window.addEventListener('touchend', () => { isDragging = false; });

            const ambient = new THREE.AmbientLight(0x404040, 1.5); scene.add(ambient);
            const moonLight = new THREE.DirectionalLight(0xaaccff, 0.8); moonLight.position.set(-10, 20, -10); moonLight.castShadow = true; scene.add(moonLight);
            elements.magicLight = new THREE.PointLight(0xd946ef, 0, 20); elements.magicLight.position.set(0, 5, 0); scene.add(elements.magicLight);

            createLandscape(); createWizard(); animate();
        }

        function updateCameraPosition() {
            // Stable rotation around the center
            camera.position.set(Math.sin(cameraAngle) * cameraRadius, 4, Math.cos(cameraAngle) * cameraRadius);
            
            // Keep correct LookAt during rotation
            if(window.innerWidth <= 768) {
                camera.lookAt(0, 4, 0); 
            } else {
                camera.lookAt(0, 2, 0);
            }
        }

        function createLandscape() {
            const theme = themes[gameState.currentTheme];
            
            const ground = new THREE.Mesh(new THREE.CylinderGeometry(40, 40, 1, 64), new THREE.MeshStandardMaterial({ color: theme.ground, flatShading: true }));
            ground.position.y = -0.5; ground.receiveShadow = true; scene.add(ground);
            elements.ground = ground; // Store reference
            
            for(let i=0; i<80; i++) {
                const angle = Math.random() * Math.PI * 2; const radius = 6 + Math.random() * 30;
                const x = Math.cos(angle) * radius; const z = Math.sin(angle) * radius;
                if (Math.abs(x) < 3 && z > 5 && z < 15) continue;
                if (Math.random() > 0.3) {
                    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.4, 1.5, 6), new THREE.MeshStandardMaterial({ color: theme.tree }));
                    const leaves = new THREE.Mesh(new THREE.ConeGeometry(1.5, 4, 8), new THREE.MeshStandardMaterial({ color: theme.leaves }));
                    leaves.position.y = 2.5; trunk.add(leaves); trunk.position.set(x, 0.75, z); trunk.castShadow = true;
                    const s = 0.8 + Math.random() * 0.5; trunk.scale.set(s,s,s); 
                    trunk.userData = { isTree: true }; // Tag for theme updates
                    scene.add(trunk);
                } else {
                    const rock = new THREE.Mesh(new THREE.DodecahedronGeometry(1 + Math.random()), new THREE.MeshStandardMaterial({ color: theme.rock, flatShading: true }));
                    rock.position.set(x, 0, z); rock.rotation.set(Math.random(), Math.random(), Math.random()); 
                    rock.userData = { isRock: true }; // Tag for theme updates
                    scene.add(rock);
                }
            }
            const pGeo = new THREE.BufferGeometry(); const pCount = 300; const pPos = new Float32Array(pCount * 3);
            for(let i=0; i<pCount*3; i++) pPos[i] = (Math.random() - 0.5) * 60;
            pGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
            elements.particles = new THREE.Points(pGeo, new THREE.PointsMaterial({ size: 0.15, color: theme.particles, transparent: true, opacity: 0.6 }));
            scene.add(elements.particles);
            
            // Update canvas background
            document.getElementById('game-canvas').style.background = 
                `radial-gradient(circle at center, #${theme.sky.toString(16).padStart(6, '0')} 0%, #000000 100%)`;
        }

        function createZTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d'); ctx.font = 'bold 40px sans-serif'; ctx.fillStyle = '#ffffff'; ctx.textAlign = 'center'; ctx.fillText('Z', 32, 48);
            return new THREE.CanvasTexture(canvas);
        }

        function createWizard() {
            const group = new THREE.Group();
            // Robe
            const robe = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 1.5, 3.5, 8), new THREE.MeshStandardMaterial({ color: 0x1e3a8a, flatShading: true }));
            robe.position.y = 1.75; robe.castShadow = true; group.add(robe);
            elements.robe = robe; // Save ref

            // Shoulders
            const shoulders = new THREE.Mesh(new THREE.CylinderGeometry(0.7, 1.6, 1.0, 8), new THREE.MeshStandardMaterial({ color: 0x4c1d95, flatShading: true }));
            shoulders.position.y = 3.0; group.add(shoulders);
            elements.shoulders = shoulders; // Save ref

            // Head
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.7, 16, 16), new THREE.MeshStandardMaterial({ color: 0xffccaa }));
            head.position.y = 3.8; group.add(head);

            // Eyes
            const eyeGeo = new THREE.BoxGeometry(0.15, 0.08, 0.1); const eyeMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
            const eyeL = new THREE.Mesh(eyeGeo, eyeMat); eyeL.position.set(0.25, 3.9, 0.6); eyeL.rotation.y = 0.2; group.add(eyeL);
            const eyeR = new THREE.Mesh(eyeGeo, eyeMat.clone()); eyeR.position.set(-0.25, 3.9, 0.6); eyeR.rotation.y = -0.2; group.add(eyeR);
            elements.eyeL = eyeL; elements.eyeR = eyeR; // Save ref

            // Hat - FIXED ALIGNMENT
            const hatGroup = new THREE.Group();
            
            // Hat cone
            const hatCone = new THREE.Mesh(new THREE.ConeGeometry(1.0, 2.5, 8), new THREE.MeshStandardMaterial({ color: 0x312e81 }));
            hatCone.position.y = 1.25; // Position from center
            hatCone.rotation.x = -0.1; // Slight tilt
            hatGroup.add(hatCone);
            
            // Hat rim (brim)
            const hatRim = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 0.12, 16), new THREE.MeshStandardMaterial({ color: 0x312e81 }));
            hatRim.position.y = 0;
            hatGroup.add(hatRim);
            
            // Golden band - FIXED: Now wraps around the base of the cone properly
            const hatBand = new THREE.Mesh(
                new THREE.TorusGeometry(0.95, 0.08, 8, 32), // Torus for a proper ring shape
                new THREE.MeshStandardMaterial({ color: 0xfbbf24, emissive: 0xfbbf24, emissiveIntensity: 0.3 })
            );
            hatBand.rotation.x = Math.PI / 2; // Rotate to horizontal
            hatBand.position.y = 0.15; // Just above the rim
            hatGroup.add(hatBand);
            
            hatGroup.position.y = 4.4; // Position on head
            group.add(hatGroup);
            elements.hatCone = hatCone; 
            elements.hatRim = hatRim;
            elements.hatBand = hatBand;

            elements.runes = []; for(let i=0; i<3; i++) { const rune = new THREE.Mesh(new THREE.OctahedronGeometry(0.3), new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true })); rune.userData = { angle: (i / 3) * Math.PI * 2, speed: 1.5, radius: 2.5, yOffset: 2 }; group.add(rune); elements.runes.push(rune); }
            const zTex = createZTexture(); const zMat = new THREE.SpriteMaterial({ map: zTex, transparent: true, opacity: 0 }); elements.zs = []; for(let i=0; i<3; i++) { const zSprite = new THREE.Sprite(zMat.clone()); zSprite.scale.set(0.5, 0.5, 1); zSprite.position.set(0.5, 5, 0); zSprite.visible = false; zSprite.userData = { offset: i * 2, speed: 0.8 }; group.add(zSprite); elements.zs.push(zSprite); }
            elements.handR = new THREE.Group(); elements.handR.position.set(1.4, 2.5, 0.5); group.add(elements.handR);
            elements.backSlot = new THREE.Group(); elements.backSlot.position.set(0, 3.0, -0.8); group.add(elements.backSlot);
            elements.headSlot = new THREE.Group(); elements.headSlot.position.set(0, 5.0, 0); group.add(elements.headSlot);
            scene.add(group); elements.wizardGroup = group;
        }

        function updateWizardGear() {
            // God Mode Check
            if(gameState.level >= 10) {
                if(elements.robe) elements.robe.material.color.setHex(0xffffff); // White Robe
                if(elements.shoulders) elements.shoulders.material.color.setHex(0xffd700); // Gold Shoulders
                if(elements.hatCone) elements.hatCone.material.color.setHex(0xffffff); // White Hat
                if(elements.hatRim) elements.hatRim.material.color.setHex(0xffffff);
                if(elements.eyeL) elements.eyeL.material.color.setHex(0xffd700); // Gold Eyes
                if(elements.eyeR) elements.eyeR.material.color.setHex(0xffd700);
            }

            if (gameState.level >= 2 && !elements.hasStaff) { const staff = new THREE.Group(); staff.add(new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 4.5), new THREE.MeshStandardMaterial({ color: 0x475569 }))); const gem = new THREE.Mesh(new THREE.OctahedronGeometry(0.35), new THREE.MeshStandardMaterial({ color: 0xf59e0b, emissive: 0xf59e0b, emissiveIntensity: 0.8 })); gem.position.y = 2.2; staff.add(gem); staff.rotation.set(0.2, 0, -0.3); elements.handR.add(staff); elements.hasStaff = true; }
            
            // Cape Fix (Clipping)
            if (gameState.level >= 3 && !elements.hasCape) { 
                const cape = new THREE.Mesh(new THREE.BoxGeometry(1.6, 2.8, 0.1), new THREE.MeshStandardMaterial({ color: 0x6366f1 })); 
                cape.position.y = -1.2; 
                cape.rotation.x = 0.35; // Increased angle to avoid butt clipping
                cape.position.z = -0.2; // Moved back slightly in local space
                elements.backSlot.add(cape); elements.cape = cape; elements.hasCape = true; 
            }
            
            // Crown Fix (Visibility)
            if (gameState.level >= 5 && !elements.hasCrown) { 
                // Larger, floating halo style
                const crown = new THREE.Mesh(new THREE.TorusGeometry(0.8, 0.08, 8, 32), new THREE.MeshBasicMaterial({ color: 0xffb020 })); 
                crown.rotation.x = Math.PI / 2; 
                crown.position.y = 1.5; // Floating way above headSlot (above hat)
                elements.headSlot.add(crown); elements.hasCrown = true; 
            }
        }

        function startWizardFocus(active) { isFocusing = active; if(active) { elements.wizardGroup.position.y = 1; elements.magicLight.intensity = 2; elements.particles.material.color.setHex(0xd946ef); elements.runes.forEach(r => { r.visible = true; r.material.color.setHex(0xd946ef); r.material.wireframe = false; }); elements.zs.forEach(z => z.visible = false); } else { elements.wizardGroup.position.y = 0; elements.magicLight.intensity = 0; elements.particles.material.color.setHex(0xc084fc); elements.runes.forEach(r => { r.visible = true; r.material.color.setHex(0x00ffff); r.material.wireframe = true; }); elements.zs.forEach(z => z.visible = false); } }
        function startWizardRest(active) { if(active) { elements.wizardGroup.position.y = -0.5; elements.wizardGroup.rotation.x = 0.2; elements.runes.forEach(r => r.visible = false); elements.zs.forEach(z => z.visible = true); } else { elements.wizardGroup.position.y = 0; elements.wizardGroup.rotation.x = 0; elements.runes.forEach(r => r.visible = true); elements.zs.forEach(z => z.visible = false); } }

        function animate() {
            requestAnimationFrame(animate); const time = Date.now() * 0.001;
            if (elements.wizardGroup) {
                if (elements.runes && elements.runes[0].visible) { elements.runes.forEach(rune => { const rData = rune.userData; const activeSpeed = isFocusing ? rData.speed * 3 : rData.speed; const activeRadius = isFocusing ? rData.radius * 0.8 : rData.radius; rune.position.x = Math.cos(time * activeSpeed + rData.angle) * activeRadius; rune.position.z = Math.sin(time * activeSpeed + rData.angle) * activeRadius; rune.position.y = rData.yOffset + Math.sin(time * 2 + rData.angle) * 0.5; rune.rotation.x += 0.02; rune.rotation.y += 0.03; }); }
                if (elements.zs && elements.zs[0].visible) { elements.zs.forEach((z, i) => { const loopTime = (time + i) % 3; z.position.y = 5 + loopTime * 0.8; z.position.x = 0.5 + Math.sin(loopTime * 3) * 0.2; z.material.opacity = 1 - (loopTime / 3); }); }
                if (!isFocusing) { if (elements.wizardGroup.rotation.x === 0) { elements.wizardGroup.position.y = Math.sin(time) * 0.2 + (gameState.stamina < 30 ? -0.5 : 0); } elements.wizardGroup.rotation.y += 0.01 * spinSpeed; if (elements.cape) elements.cape.rotation.x = 0.35 + Math.sin(time * 5) * 0.1; } else { elements.wizardGroup.rotation.y += 0.05; elements.wizardGroup.position.y = 1 + Math.sin(time * 5) * 0.1; }
            }
            if (elements.particles) elements.particles.rotation.y = time * (isFocusing ? 0.2 : 0.05);
            renderer.render(scene, camera);
        }

        function startGame() {
            const name = document.getElementById('char-name-input').value || "Dev"; 
            
            // Check for saved game
            if (rpgSystem.loadGame()) {
                // Use saved name if input is empty
                if (!document.getElementById('char-name-input').value) {
                    // Keep loaded name
                } else {
                    gameState.name = name;
                }
            } else {
                gameState.name = name;
            }
            
            document.getElementById('login-overlay').classList.remove('active');
            initWorld(); 
            rpgSystem.updateUI();
        }
        
        window.addEventListener('keydown', (e) => { if (e.altKey && e.shiftKey && (e.key === 'd' || e.key === 'D')) { e.preventDefault(); document.getElementById('admin-panel').classList.toggle('active'); } });
        window.addEventListener('resize', () => { if (camera && renderer) { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); updateCameraPosition(); } });

    </script>
</body>
</html>
