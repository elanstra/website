<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Pomodoro - Premium UI</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Palette based on reference image */
            --bg-dark: #09090b;
            --glass-bg: rgba(20, 20, 35, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            
            --primary-gradient: linear-gradient(135deg, #8b5cf6 0%, #d946ef 100%); /* Purple/Pink */
            --gold-gradient: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);   /* Gold */
            --blue-gradient: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);   /* Blue */
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #f43f5e 100%); /* Red */
            
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* --- 3D Canvas Layer --- */
        #game-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            background: radial-gradient(circle at center, #1e1b4b 0%, #000000 100%);
            cursor: grab;
        }
        #game-canvas.grabbing { cursor: grabbing; }

        /* --- UI HUD Layer --- */
        .hud {
            position: absolute; z-index: 10; padding: 24px;
            pointer-events: none; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .hud__interactive { pointer-events: auto; }

        /* --- TOP STATS BAR --- */
        .stats-bar {
            display: flex; gap: 16px; 
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 12px 20px;
            border-radius: var(--radius-lg);
            backdrop-filter: blur(12px);
            align-self: flex-start;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            min-width: 320px;
            align-items: center;
        }

        .avatar-circle {
            width: 48px; height: 48px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; color: white;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
            border: 2px solid rgba(255,255,255,0.2);
        }

        .stat-group { display: flex; flex-direction: column; flex: 1; }
        
        .char-name { font-weight: 800; font-size: 0.9rem; letter-spacing: 0.5px; margin-bottom: 4px; }
        
        .resource-row { display: flex; align-items: center; gap: 12px; margin-top: 2px; }
        
        .bar-wrapper { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .bar-label { font-size: 0.65rem; color: var(--text-muted); font-weight: 600; display: flex; justify-content: space-between; }
        
        .progress-track {
            width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; width: 0%; border-radius: 10px; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Specific Colors */
        .xp-fill { background: var(--gold-gradient); box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); }
        .stamina-fill { background: var(--primary-gradient); box-shadow: 0 0 10px rgba(139, 92, 246, 0.5); }
        .stamina-fill.low { background: var(--danger-gradient); }

        /* --- QUEST BOARD (Right Side) --- */
        .quest-log {
            position: absolute; top: 100px; right: 24px; width: 360px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(12px);
            max-height: 70vh; display: flex; flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        .quest-header {
            padding: 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; justify-content: space-between; align-items: center;
        }
        .quest-header h3 { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        
        .icon-btn {
            width: 32px; height: 32px; border-radius: 8px;
            background: rgba(255,255,255,0.1); border: none; color: white;
            cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background: white; color: black; transform: translateY(-2px); }

        .quest-content { overflow-y: auto; flex: 1; padding: 16px; display: flex; flex-direction: column; gap: 16px; }
        
        .section-label { 
            font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; 
            display: flex; align-items: center; gap: 8px;
        }
        .section-label::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1); }

        .quest-list { list-style: none; display: flex; flex-direction: column; gap: 10px; }

        /* Quest Cards */
        .quest-card {
            background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            display: flex; align-items: center; gap: 12px;
            transition: all 0.2s;
            position: relative; overflow: hidden;
        }
        .quest-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); }
        
        .quest-icon {
            width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; color: white; flex-shrink: 0;
        }
        
        .quest-details { flex: 1; display: flex; flex-direction: column; }
        .quest-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; }
        .quest-reward { font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
        .highlight-xp { color: #fbbf24; font-weight: 700; }

        .quest-actions { display: flex; gap: 8px; }
        .action-play { 
            color: #4ade80; background: rgba(74, 222, 128, 0.15); 
            width: 32px; height: 32px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; 
        }
        .action-play:hover { background: #4ade80; color: black; box-shadow: 0 0 10px #4ade80; }
        
        .action-del { color: #f87171; opacity: 0.5; cursor: pointer; padding: 5px; transition: 0.2s; }
        .action-del:hover { opacity: 1; transform: scale(1.1); }

        /* Type Styling */
        .type-light .quest-icon { background: rgba(46, 204, 113, 0.2); color: #2ecc71; box-shadow: 0 0 10px rgba(46, 204, 113, 0.1); }
        .type-medium .quest-icon { background: rgba(241, 196, 15, 0.2); color: #f1c40f; box-shadow: 0 0 10px rgba(241, 196, 15, 0.1); }
        .type-heavy .quest-icon { background: rgba(239, 68, 68, 0.2); color: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.1); }

        /* --- BOTTOM CONTROLS --- */
        .bottom-hud {
            align-self: center; display: flex; flex-direction: column; align-items: center; gap: 20px; 
            margin-bottom: 40px; pointer-events: auto; width: 100%;
        }

        /* The Timer Panel */
        .hud-timer-panel {
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.1);
            border-top: 2px solid #8b5cf6;
            border-radius: var(--radius-lg);
            padding: 20px 40px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 300px;
        }
        .hud-timer-panel.hidden { display: none; }

        .timer-label { font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; }
        .timer-digits { font-size: 3.5rem; line-height: 1; font-weight: 700; font-variant-numeric: tabular-nums; 
            background: linear-gradient(180deg, #fff 0%, #aaa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        
        .timer-actions { display: flex; gap: 12px; margin-top: 15px; width: 100%; justify-content: center; }

        .btn-pill {
            padding: 8px 20px; border-radius: 50px; border: none; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: all 0.2s;
        }
        .btn-finish { background: var(--primary-gradient); color: white; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); }
        .btn-finish:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6); }
        .btn-cancel { background: rgba(255,255,255,0.1); color: #ccc; }
        .btn-cancel:hover { background: rgba(255,255,255,0.2); color: white; }

        /* Quick Dock */
        .dock {
            display: flex; gap: 12px; 
            background: rgba(10, 10, 20, 0.7);
            border: 1px solid rgba(255,255,255,0.08);
            padding: 10px 16px; border-radius: 50px;
            backdrop-filter: blur(10px);
            transition: opacity 0.3s;
        }
        .dock.disabled { opacity: 0; pointer-events: none; transform: translateY(20px); }

        .dock-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.15); color: #ccc;
            padding: 10px 20px; border-radius: 30px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 8px; font-size: 0.85rem; transition: all 0.2s;
        }
        .dock-btn:hover { background: rgba(255,255,255,0.1); color: white; border-color: white; transform: translateY(-3px); }
        
        .dock-btn.start-light { border-color: #2ecc71; color: #2ecc71; }
        .dock-btn.start-light:hover { background: #2ecc71; color: #000; box-shadow: 0 0 15px rgba(46, 204, 113, 0.4); }

        .dock-btn.start-med { border-color: #f1c40f; color: #f1c40f; }
        .dock-btn.start-med:hover { background: #f1c40f; color: #000; box-shadow: 0 0 15px rgba(241, 196, 15, 0.4); }

        .dock-btn.start-heavy { border-color: #ef4444; color: #ef4444; }
        .dock-btn.start-heavy:hover { background: #ef4444; color: #000; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }

        .dock-btn.start-rest { border-color: #8b5cf6; color: #8b5cf6; }
        .dock-btn.start-rest:hover { background: #8b5cf6; color: white; box-shadow: 0 0 15px rgba(139, 92, 246, 0.4); }


        /* --- MODALS & OVERLAYS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal-card {
            background: #18181b; border: 1px solid #3f3f46;
            padding: 30px; border-radius: 24px;
            width: 400px; max-width: 90%; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            position: relative; overflow: hidden;
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.active .modal-card { transform: scale(1); }
        
        /* Decorative glow inside modal */
        .modal-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        .modal-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 8px; background: linear-gradient(90deg, #fff, #ccc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .modal-desc { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 24px; line-height: 1.5; }

        .input-group { margin-bottom: 24px; text-align: left; }
        .input-label { display: block; font-size: 0.8rem; color: #aaa; margin-bottom: 8px; margin-left: 4px; }
        .styled-input {
            width: 100%; padding: 16px; border-radius: 12px; border: 1px solid #333;
            background: #09090b; color: white; font-size: 1rem; outline: none; transition: 0.2s;
        }
        .styled-input:focus { border-color: #8b5cf6; box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1); }

        .plan-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 24px; }
        .plan-option {
            background: #27272a; border: 1px solid #3f3f46; border-radius: 12px; padding: 15px 5px; cursor: pointer; transition: 0.2s; position: relative;
        }
        .plan-option:hover { background: #3f3f46; transform: translateY(-2px); }
        .plan-option.selected { border-color: #8b5cf6; background: rgba(139, 92, 246, 0.1); }
        .plan-option h4 { font-size: 0.9rem; margin-bottom: 4px; }
        .plan-option p { font-size: 0.7rem; color: #888; margin: 0; }
        .plan-option i { font-size: 1.2rem; margin-bottom: 8px; display: block; }

        .btn-full { width: 100%; padding: 16px; border-radius: 16px; background: var(--primary-gradient); color: white; font-weight: 700; border: none; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-full:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4); }

        /* Toasts */
        .toast-container { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); z-index: 200; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast {
            background: #18181b; border: 1px solid #333; color: white; padding: 12px 24px; border-radius: 50px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: floatUp 3s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .toast i { color: #f59e0b; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes floatUp { 0% { opacity: 0; transform: translateY(30px); } 10% { opacity: 1; transform: translateY(0); } 90% { opacity: 1; transform: translateY(-10px); } 100% { opacity: 0; transform: translateY(-20px); } }
        
        .drag-hint { position: absolute; bottom: 20px; left: 20px; color: rgba(255,255,255,0.2); font-size: 0.8rem; pointer-events: none; }
        .close-icon { position: absolute; top: 15px; right: 15px; cursor: pointer; opacity: 0.5; font-size: 1.2rem; }
        .close-icon:hover { opacity: 1; }

    </style>
</head>
<body>

    <canvas id="game-canvas"></canvas>
    <div class="drag-hint"><i class="fas fa-hand-pointer"></i> Drag to rotate camera</div>

    <!-- HUD -->
    <div class="hud">
        <!-- Top Stats Bar -->
        <div class="stats-bar hud__interactive">
            <div class="avatar-circle">
                <i class="fas fa-user-astronaut"></i>
            </div>
            
            <div class="stat-group">
                <div class="char-name" id="char-name-display">Player One</div>
                
                <!-- XP Bar -->
                <div class="resource-row">
                    <div style="width: 20px; text-align:center; color:#fbbf24;"><i class="fas fa-crown"></i></div>
                    <div class="bar-wrapper">
                        <div class="bar-label">
                            <span>Level <span id="level-val">1</span></span>
                            <span style="font-weight:400; opacity:0.7;"><span id="xp-current">0</span> XP</span>
                        </div>
                        <div class="progress-track"><div class="progress-fill xp-fill" id="xp-bar" style="width: 0%"></div></div>
                    </div>
                </div>

                <!-- Stamina Bar -->
                <div class="resource-row">
                    <div style="width: 20px; text-align:center; color:#8b5cf6;"><i class="fas fa-bolt"></i></div>
                    <div class="bar-wrapper">
                        <div class="bar-label"><span>Focus Energy</span></div>
                        <div class="progress-track"><div class="progress-fill stamina-fill" id="stamina-bar" style="width: 100%"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side Quest Log -->
        <div class="quest-log hud__interactive">
            <div class="quest-header">
                <h3><i class="fas fa-scroll" style="color:#d946ef"></i> Active Quests</h3>
                <button class="icon-btn" onclick="rpgSystem.openPlanner()"><i class="fas fa-plus"></i></button>
            </div>
            
            <div class="quest-content">
                <div class="section-label">Quest Board</div>
                <div class="quest-list" id="planned-list">
                    <!-- Dynamic Items -->
                </div>

                <div class="section-label" style="margin-top:10px;">Completions</div>
                <div class="quest-list" id="history-list" style="opacity: 0.5; pointer-events:none;">
                    <!-- History Items -->
                </div>
            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="bottom-hud">
            <!-- TIMER PANEL (Hidden by default) -->
            <div id="hud-timer-panel" class="hud-timer-panel hidden">
                <div id="hud-timer-label" class="timer-label">Current Task</div>
                <div id="hud-timer-val" class="timer-digits">25:00</div>
                
                <div class="timer-actions">
                    <button class="btn-pill btn-cancel" onclick="rpgSystem.cancelAction()">
                        <i class="fas fa-times"></i> Stop
                    </button>
                    <button id="hud-finish-btn" class="btn-pill btn-finish" onclick="rpgSystem.finishAction()">
                        <i class="fas fa-check"></i> Complete
                    </button>
                </div>
            </div>

            <!-- DOCK CONTROLS -->
            <div class="dock hud__interactive" id="controls-bar">
                <button class="dock-btn start-light" onclick="rpgSystem.quickStart('light')">
                    <i class="fas fa-seedling"></i> 5m
                </button>
                <button class="dock-btn start-med" onclick="rpgSystem.quickStart('medium')">
                    <i class="fas fa-fire"></i> 15m
                </button>
                <button class="dock-btn start-heavy" onclick="rpgSystem.quickStart('heavy')">
                    <i class="fas fa-dragon"></i> 25m
                </button>
                <div style="width:1px; background:rgba(255,255,255,0.2); height:20px; margin:0 5px;"></div>
                <button class="dock-btn start-rest" onclick="rpgSystem.startRest()">
                    <i class="fas fa-moon"></i> Rest
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIN OVERLAY -->
    <div class="modal-overlay active" id="login-overlay">
        <div class="modal-card">
            <div class="icon-circle" style="font-size: 3rem; margin-bottom: 20px; background: -webkit-linear-gradient(#8b5cf6, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                <i class="fas fa-dungeon"></i>
            </div>
            <h2 class="modal-title">RPG Pomodoro</h2>
            <p class="modal-desc">Enter the realm of focus. Complete tasks to level up your wizard.</p>
            
            <div class="input-group">
                <input type="text" class="styled-input" id="char-name-input" placeholder="Enter Character Name..." autocomplete="off">
            </div>
            
            <button class="btn-full" onclick="startGame()">Enter World <i class="fas fa-arrow-right" style="margin-left:8px;"></i></button>
        </div>
    </div>

    <!-- PLANNER MODAL -->
    <div class="modal-overlay" id="planner-modal">
        <div class="modal-card">
            <i class="fas fa-times close-icon" onclick="document.getElementById('planner-modal').classList.remove('active')"></i>
            <h2 class="modal-title">New Quest</h2>
            <p class="modal-desc">Define your task and choose the difficulty.</p>
            
            <div class="input-group">
                <input type="text" class="styled-input" id="plan-input" placeholder="e.g. Fix Navigation Bug..." autocomplete="off">
            </div>

            <div class="plan-grid">
                <div class="plan-option" onclick="rpgSystem.addPlannedTask('light')">
                    <i class="fas fa-seedling" style="color:#2ecc71;"></i>
                    <h4>Light</h4>
                    <p>5 min</p>
                </div>
                <div class="plan-option" onclick="rpgSystem.addPlannedTask('medium')">
                    <i class="fas fa-fire" style="color:#f1c40f;"></i>
                    <h4>Medium</h4>
                    <p>15 min</p>
                </div>
                <div class="plan-option" onclick="rpgSystem.addPlannedTask('heavy')">
                    <i class="fas fa-dragon" style="color:#ef4444;"></i>
                    <h4>Heavy</h4>
                    <p>25 min</p>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- GAME LOGIC ---
        const gameState = {
            name: "Dev",
            level: 1,
            xp: 0,
            xpToNext: 1000,
            stamina: 100,
            plannedTasks: [],
            completedTasks: [],
            activeTask: null,
            timerInterval: null
        };

        const gearUnlocks = {
            2: "Magic Staff",
            3: "Mystic Cape",
            5: "Crown of Focus",
            10: "God Mode Aura"
        };

        const taskDefinitions = {
            light: { t: "Light", m: 5, x: 50, s: 5, icon: "fa-seedling" },
            medium: { t: "Medium", m: 15, x: 150, s: 15, icon: "fa-fire" },
            heavy: { t: "Heavy", m: 25, x: 500, s: 30, icon: "fa-dragon" }
        };

        const rpgSystem = {
            updateUI: () => {
                document.getElementById('char-name-display').innerText = gameState.name;
                document.getElementById('level-val').innerText = gameState.level;
                document.getElementById('xp-current').innerText = gameState.xp;
                
                const xpPercent = (gameState.xp / gameState.xpToNext) * 100;
                document.getElementById('xp-bar').style.width = `${xpPercent}%`;
                
                const stamBar = document.getElementById('stamina-bar');
                stamBar.style.width = `${gameState.stamina}%`;
                
                // Color change logic for stamina
                if (gameState.stamina < 30) {
                    stamBar.classList.add('low');
                } else {
                    stamBar.classList.remove('low');
                }

                if (typeof scene !== 'undefined' && scene && scene.fog) {
                    scene.fog.color.setHex(gameState.stamina < 30 ? 0x000000 : 0x1e1b4b);
                    scene.fog.density = gameState.stamina < 30 ? 0.08 : 0.02;
                }

                rpgSystem.renderBoards();
                updateWizardGear();
            },

            renderBoards: () => {
                const pList = document.getElementById('planned-list');
                pList.innerHTML = '';
                
                if(gameState.plannedTasks.length === 0) {
                    pList.innerHTML = `<div style="text-align:center; padding:20px; color:#555; font-size:0.8rem;">
                        <i class="fas fa-ghost" style="font-size:1.5rem; margin-bottom:5px;"></i><br>No active quests
                    </div>`;
                }

                gameState.plannedTasks.forEach(t => {
                    const def = taskDefinitions[t.type];
                    const div = document.createElement('div');
                    div.className = `quest-card type-${t.type}`;
                    div.innerHTML = `
                        <div class="quest-icon"><i class="fas ${def.icon}"></i></div>
                        <div class="quest-details">
                            <div class="quest-name">${t.title}</div>
                            <div class="quest-reward"><span class="highlight-xp">+${def.x} XP</span> â€¢ ${def.m} min</div>
                        </div>
                        <div class="quest-actions">
                            <div class="action-play" onclick="rpgSystem.startPlannedTask(${t.id})"><i class="fas fa-play" style="font-size:0.7rem;"></i></div>
                            <div class="action-del" onclick="rpgSystem.deletePlannedTask(${t.id})"><i class="fas fa-trash"></i></div>
                        </div>
                    `;
                    pList.appendChild(div);
                });

                const hList = document.getElementById('history-list');
                hList.innerHTML = '';
                gameState.completedTasks.slice(-3).reverse().forEach(t => {
                    const div = document.createElement('div');
                    div.className = `quest-card type-${t.type}`;
                    div.style.opacity = "0.7";
                    div.innerHTML = `
                         <div class="quest-icon"><i class="fas fa-check"></i></div>
                         <div class="quest-details">
                            <div class="quest-name" style="text-decoration:line-through;">${t.title}</div>
                         </div>
                    `;
                    hList.appendChild(div);
                });
            },

            // --- PLANNER LOGIC ---
            openPlanner: () => {
                document.getElementById('plan-input').value = "";
                document.getElementById('planner-modal').classList.add('active');
                document.getElementById('plan-input').focus();
            },

            addPlannedTask: (type) => {
                const title = document.getElementById('plan-input').value || `${type.charAt(0).toUpperCase() + type.slice(1)} Task`;
                const newTask = {
                    id: Date.now(), title: title, type: type,
                    xp: taskDefinitions[type].x, cost: taskDefinitions[type].s, duration: taskDefinitions[type].m * 60
                };
                gameState.plannedTasks.push(newTask);
                document.getElementById('planner-modal').classList.remove('active');
                rpgSystem.updateUI();
                rpgSystem.showToast("Quest Added", "fa-scroll");
            },

            deletePlannedTask: (id) => {
                gameState.plannedTasks = gameState.plannedTasks.filter(t => t.id !== id);
                rpgSystem.updateUI();
            },

            startPlannedTask: (id) => {
                const task = gameState.plannedTasks.find(t => t.id === id);
                if (!task) return;
                if (gameState.stamina <= 10) return rpgSystem.showToast("Stamina Low! Rest needed.", "fa-battery-empty");

                gameState.activeTask = { ...task };
                gameState.plannedTasks = gameState.plannedTasks.filter(t => t.id !== id);
                rpgSystem.updateUI();
                rpgSystem.initTimerUI(false);
            },

            quickStart: (type) => {
                if (gameState.stamina <= 10) return rpgSystem.showToast("Stamina Low! Rest needed.", "fa-battery-empty");
                const def = taskDefinitions[type];
                gameState.activeTask = { 
                    title: "Quick Quest", type, xp: def.x, cost: def.s, duration: def.m * 60 
                };
                rpgSystem.initTimerUI(false);
            },

            startRest: () => {
                gameState.activeTask = { type: 'rest', xp: 0, cost: 0, duration: 5 * 60, title: "Mana Recharge" };
                rpgSystem.initTimerUI(true);
            },

            // --- TIMER ENGINE ---
            initTimerUI: (isRest) => {
                document.getElementById('controls-bar').classList.add('disabled');
                document.getElementById('hud-timer-panel').classList.remove('hidden');
                
                if (isRest) {
                    document.getElementById('hud-timer-label').innerText = "MEDITATING...";
                    document.getElementById('hud-finish-btn').style.display = 'none';
                    startWizardRest(true);
                } else {
                    document.getElementById('hud-timer-label').innerText = gameState.activeTask.title;
                    document.getElementById('hud-finish-btn').style.display = 'flex';
                    startWizardFocus(true);
                }

                let timeLeft = gameState.activeTask.duration;
                updateTimerDisplay(timeLeft);

                if (gameState.timerInterval) clearInterval(gameState.timerInterval);
                gameState.timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay(timeLeft);
                    if (timeLeft <= 0) {
                        clearInterval(gameState.timerInterval);
                        rpgSystem.finishAction();
                    }
                }, 1000); // 1s
            },

            finishAction: () => {
                if (gameState.timerInterval) clearInterval(gameState.timerInterval);
                const task = gameState.activeTask;
                
                document.getElementById('hud-timer-panel').classList.add('hidden');
                document.getElementById('controls-bar').classList.remove('disabled');
                
                startWizardFocus(false);
                startWizardRest(false);

                if (task.type === 'rest') {
                    gameState.stamina = 100;
                    rpgSystem.showToast("Mana Restored Full", "fa-bolt");
                } else {
                    gameState.stamina = Math.max(0, gameState.stamina - task.cost);
                    gameState.xp += task.xp;
                    gameState.completedTasks.push({ title: task.title, xp: task.xp, type: task.type });
                    rpgSystem.showToast(`Quest Complete! +${task.xp} XP`, "fa-check-circle");
                    
                    if(elements.wizardGroup) {
                        elements.wizardGroup.position.y += 1;
                        const flash = new THREE.PointLight(0xffffff, 2, 10);
                        flash.position.set(0,2,0);
                        scene.add(flash);
                        setTimeout(() => scene.remove(flash), 200);
                    }
                    if (gameState.xp >= gameState.xpToNext) rpgSystem.levelUp();
                }
                rpgSystem.updateUI();
            },

            cancelAction: () => {
                if (gameState.timerInterval) clearInterval(gameState.timerInterval);
                document.getElementById('hud-timer-panel').classList.add('hidden');
                document.getElementById('controls-bar').classList.remove('disabled');
                startWizardFocus(false);
                startWizardRest(false);
                rpgSystem.showToast("Focus Interrupted", "fa-ban");
                rpgSystem.updateUI();
            },

            levelUp: () => {
                gameState.level++;
                gameState.xp -= gameState.xpToNext;
                gameState.xpToNext = Math.floor(gameState.xpToNext * 1.3);
                rpgSystem.showToast(`Level Up! You are now Lvl ${gameState.level}`, "fa-level-up-alt");
                if(gearUnlocks[gameState.level]) setTimeout(() => rpgSystem.showToast(`Unbox: ${gearUnlocks[gameState.level]}`, "fa-box-open"), 1500);
                rpgSystem.updateUI();
            },

            showToast: (msg, icon) => {
                const div = document.createElement('div');
                div.className = 'toast'; 
                div.innerHTML = `<i class="fas ${icon || 'fa-info-circle'}"></i> ${msg}`;
                document.getElementById('toast-container').appendChild(div);
                setTimeout(() => div.remove(), 3000);
            }
        };

        function updateTimerDisplay(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('hud-timer-val').innerText = `${m}:${s}`;
        }

        // --- 3D ENGINE ---
        let scene, camera, renderer, elements = {};
        let spinSpeed = 1; let isFocusing = false;
        let cameraAngle = 0; const cameraRadius = 13;
        let isDragging = false; let previousMouseX = 0;

        function initWorld() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x1e1b4b, 0.02); // Dark blue fog

            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            updateCameraPosition();

            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('game-canvas'), antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;

            const canvas = document.getElementById('game-canvas');
            canvas.addEventListener('mousedown', (e) => { isDragging = true; previousMouseX = e.clientX; canvas.classList.add('grabbing'); });
            window.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    cameraAngle -= (e.clientX - previousMouseX) * 0.005;
                    updateCameraPosition();
                    previousMouseX = e.clientX;
                }
            });
            window.addEventListener('mouseup', () => { isDragging = false; canvas.classList.remove('grabbing'); });

            const ambient = new THREE.AmbientLight(0x404040, 1.5); scene.add(ambient);
            const moonLight = new THREE.DirectionalLight(0xaaccff, 0.8); moonLight.position.set(-10, 20, -10); moonLight.castShadow = true; scene.add(moonLight);
            
            // Magic light (Purple now)
            elements.magicLight = new THREE.PointLight(0xd946ef, 0, 20); elements.magicLight.position.set(0, 5, 0); scene.add(elements.magicLight);

            createLandscape(); createWizard(); animate();
        }

        function updateCameraPosition() {
            camera.position.set(Math.sin(cameraAngle) * cameraRadius, 4, Math.cos(cameraAngle) * cameraRadius);
            camera.lookAt(0, 2, 0);
        }

        function createLandscape() {
            // Darker ground
            const ground = new THREE.Mesh(new THREE.CylinderGeometry(40, 40, 1, 64), new THREE.MeshStandardMaterial({ color: 0x0f172a, flatShading: true }));
            ground.position.y = -0.5; ground.receiveShadow = true; scene.add(ground);

            for(let i=0; i<80; i++) {
                const angle = Math.random() * Math.PI * 2; const radius = 6 + Math.random() * 30;
                const x = Math.cos(angle) * radius; const z = Math.sin(angle) * radius;
                if (Math.abs(x) < 3 && z > 5 && z < 15) continue;

                if (Math.random() > 0.3) {
                    // Darker trees
                    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.4, 1.5, 6), new THREE.MeshStandardMaterial({ color: 0x1e1b4b }));
                    const leaves = new THREE.Mesh(new THREE.ConeGeometry(1.5, 4, 8), new THREE.MeshStandardMaterial({ color: 0x334155 })); // Slate color
                    leaves.position.y = 2.5; trunk.add(leaves); trunk.position.set(x, 0.75, z); trunk.castShadow = true;
                    const s = 0.8 + Math.random() * 0.5; trunk.scale.set(s,s,s); scene.add(trunk);
                } else {
                    const rock = new THREE.Mesh(new THREE.DodecahedronGeometry(1 + Math.random()), new THREE.MeshStandardMaterial({ color: 0x1e293b, flatShading: true }));
                    rock.position.set(x, 0, z); rock.rotation.set(Math.random(), Math.random(), Math.random()); scene.add(rock);
                }
            }
            
            // Particles (Purple/Pink now)
            const pGeo = new THREE.BufferGeometry(); const pCount = 300; const pPos = new Float32Array(pCount * 3);
            for(let i=0; i<pCount*3; i++) pPos[i] = (Math.random() - 0.5) * 60;
            pGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
            elements.particles = new THREE.Points(pGeo, new THREE.PointsMaterial({ size: 0.15, color: 0xc084fc, transparent: true, opacity: 0.6 }));
            scene.add(elements.particles);
        }

        function createWizard() {
            const group = new THREE.Group();
            
            // Neon Robe
            const robe = new THREE.Mesh(new THREE.ConeGeometry(1.2, 3.5, 7), new THREE.MeshStandardMaterial({ color: 0x3b82f6, flatShading: true }));
            robe.position.y = 1.75; robe.castShadow = true; group.add(robe);
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.7, 12, 12), new THREE.MeshStandardMaterial({ color: 0xffccaa }));
            head.position.y = 3.2; group.add(head);

            const hatGroup = new THREE.Group();
            hatGroup.add(new THREE.Mesh(new THREE.ConeGeometry(0.8, 2, 8), new THREE.MeshStandardMaterial({ color: 0x172554 })).translateX(0).translateY(1).rotateX(-0.2));
            hatGroup.add(new THREE.Mesh(new THREE.CylinderGeometry(1.2, 1.2, 0.1, 8), new THREE.MeshStandardMaterial({ color: 0x172554 })));
            hatGroup.position.y = 3.5; group.add(hatGroup);

            elements.handR = new THREE.Group(); elements.handR.position.set(1.0, 2.2, 0.6); group.add(elements.handR);
            elements.backSlot = new THREE.Group(); elements.backSlot.position.set(0, 3, -0.8); group.add(elements.backSlot);
            elements.headSlot = new THREE.Group(); elements.headSlot.position.set(0, 4.2, 0); group.add(elements.headSlot);

            scene.add(group); elements.wizardGroup = group;
        }

        function updateWizardGear() {
            if (gameState.level >= 2 && !elements.hasStaff) {
                const staff = new THREE.Group();
                staff.add(new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 4), new THREE.MeshStandardMaterial({ color: 0x475569 })));
                const gem = new THREE.Mesh(new THREE.IcosahedronGeometry(0.3), new THREE.MeshStandardMaterial({ color: 0xf59e0b, emissive: 0xf59e0b }));
                gem.position.y = 2; staff.add(gem);
                staff.rotation.set(0.2, 0, -0.3); elements.handR.add(staff); elements.hasStaff = true;
            }
            if (gameState.level >= 3 && !elements.hasCape) {
                const cape = new THREE.Mesh(new THREE.BoxGeometry(1.4, 2.5, 0.1), new THREE.MeshStandardMaterial({ color: 0x6366f1 }));
                cape.position.y = -1; cape.rotation.x = 0.3; elements.backSlot.add(cape); elements.cape = cape; elements.hasCape = true;
            }
            if (gameState.level >= 5 && !elements.hasCrown) {
                const crown = new THREE.Mesh(new THREE.TorusGeometry(0.5, 0.05, 8, 32), new THREE.MeshBasicMaterial({ color: 0xffb020 }));
                crown.rotation.x = Math.PI / 2; elements.headSlot.add(crown); elements.hasCrown = true;
            }
        }

        function startWizardFocus(active) {
            isFocusing = active;
            if(active) {
                elements.wizardGroup.position.y = 1; elements.magicLight.intensity = 2; 
                elements.particles.material.color.setHex(0xd946ef); // Pink energy
            } else {
                elements.wizardGroup.position.y = 0; elements.magicLight.intensity = 0; 
                elements.particles.material.color.setHex(0xc084fc); // Purple idle
            }
        }

        function startWizardRest(active) {
            if(active) { elements.wizardGroup.position.y = -0.5; elements.wizardGroup.rotation.x = 0.2; }
            else { elements.wizardGroup.position.y = 0; elements.wizardGroup.rotation.x = 0; }
        }

        function animate() {
            requestAnimationFrame(animate); const time = Date.now() * 0.001;
            if (elements.wizardGroup && !isFocusing) {
                elements.wizardGroup.position.y = Math.sin(time) * 0.2 + (gameState.stamina < 30 ? -0.5 : 0);
                elements.wizardGroup.rotation.y += 0.01 * spinSpeed;
                if (elements.cape) elements.cape.rotation.x = 0.3 + Math.sin(time * 5) * 0.1;
            } else if (elements.wizardGroup && isFocusing) {
                elements.wizardGroup.rotation.y += 0.05; elements.wizardGroup.position.y = 1 + Math.sin(time * 5) * 0.1;
            }
            if (elements.particles) elements.particles.rotation.y = time * (isFocusing ? 0.2 : 0.05);
            renderer.render(scene, camera);
        }

        function startGame() {
            const name = document.getElementById('char-name-input').value || "Dev";
            gameState.name = name;
            document.getElementById('login-overlay').classList.remove('active');
            initWorld(); rpgSystem.updateUI();
        }
        
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

    </script>
</body>
</html>
